<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Todo Flow – Modern CRUD with Files</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root {
      --primary: #007bff;
      --success: #28a745;
      --danger: #dc3545;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      box-sizing: border-box;
      transition: background 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    body {
      background: linear-gradient(to right top, #6a11cb, #2575fc);
      color: #222;
    }

    body.dark {
      background: #121212;
      color: #fff;
    }

    .container {
      max-width: 600px;
      margin: 2rem auto;
      padding: 1.2rem;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }

    body.dark .container {
      background: rgba(30, 30, 30, 0.9);
    }

    h1 {
      text-align: center;
      margin-bottom: 1.2rem;
    }

    form#taskForm {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    form#taskForm input[type="text"],
    form#taskForm input[type="file"] {
      flex: 1 1 100%;
      padding: 0.5rem;
      font-size: 1rem;
    }

    form#taskForm button[type="submit"] {
      flex: 1 1 100%;
      padding: 0.6rem;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    form#taskForm button[type="submit"]:hover {
      background: #218838;
    }

    @media (min-width: 768px) {
      form#taskForm input[type="text"] { min-width: 250px; }
      form#taskForm input[type="file"] { min-width: 180px; }
      form#taskForm button[type="submit"] { min-width: 100px; }
    }

    .filters {
      display: flex;
      gap: 10px;
      margin: 1rem 0;
      flex-wrap: wrap;
      align-items: center;
    }

    .filters select,
    .filters button {
      padding: 0.5rem 1rem;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      border-radius: 5px;
      transition: background 0.3s;
    }

    .filters button.active {
      background: #0056b3;
    }

    .task {
      background: rgba(255,255,255,0.9);
      padding: 0.8rem;
      margin-bottom: 0.6rem;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    body.dark .task {
      background: #2a2a2a;
    }

    .task-content {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .task.completed span {
      text-decoration: line-through;
      color: gray;
    }

    .attachment {
      margin-top: 4px;
    }

    .attachment a {
      font-size: 0.9em;
      color: var(--primary);
    }

    .actions {
      display: flex;
      gap: 0.5rem;
    }

    .actions button {
      padding: 4px 8px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.85rem;
      background: var(--primary);
      color: white;
    }

    .actions button.delete {
      background: var(--danger);
    }

    .editField {
      padding: 5px;
      font-size: 1rem;
      border-radius: 4px;
    }

    /* Loader */
    .pl {
      display: none;
      position: fixed;
      top: 400px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    body.loading .pl {
      display: block;
      opacity: 1;
    }

    /* Dark mode switch */
    .ui-switch {
      --switch-width: 48px;
      --switch-height: 24px;
      --circle-size: 22px;
      position: relative;
      width: var(--switch-width);
      height: var(--switch-height);
      display: inline-block;
    }

    .ui-switch input {
      display: none;
    }

    .ui-switch .slider {
      background: #aaa;
      border-radius: var(--switch-height);
      height: var(--switch-height);
      position: relative;
      transition: background 0.3s;
    }

    .ui-switch .circle {
      background: white;
      border-radius: 50%;
      width: var(--circle-size);
      height: var(--circle-size);
      position: absolute;
      top: 1px;
      left: 1px;
      transition: transform 0.3s;
    }

    .ui-switch input:checked + .slider .circle {
      transform: translateX(calc(var(--switch-width) - var(--circle-size) - 2px));
    }

    /* Responsive */
    @media (max-width: 500px) {
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Todo Flow</h1>
    <form id="taskForm">
      <input id="taskInput" type="text" placeholder="New task" required />
      <input type="file" id="fileInput" name="attachment" />
      <button type="submit">Add</button>
    </form>

    <div class="filters">
      <select id="filter">
        <option value="all">All</option>
        <option value="completed">Completed</option>
        <option value="incomplete">Incomplete</option>
        <option value="trashed">Trash</option>
      </select>
      <button id="completedBtn">✔ Completed</button>
      <label class="ui-switch" style="margin-left:auto;">
        <input type="checkbox" id="themeToggle" />
        <div class="slider"><div class="circle"></div></div>
      </label>
    </div>

    <ul id="taskList"></ul>
  </div>

  <!-- 🌀 Loader SVG -->
  <svg class="pl" viewBox="0 0 100 100" width="100" height="100">
    <circle cx="50" cy="50" r="40" stroke="#007bff" stroke-width="10" fill="none" stroke-dasharray="188.5" stroke-linecap="round">
      <animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" from="0 50 50" to="360 50 50"/>
    </circle>
  </svg>

  <script>
    const API = '/api/tasks';
    const $ = (s, c = document) => c.querySelector(s);
    const form = $('#taskForm'), input = $('#taskInput'), fileInput = $('#fileInput'), list = $('#taskList'),
          filter = $('#filter'), completedBtn = $('#completedBtn');
    let currentFilter = 'all';

    async function loadTasks() {
      document.body.classList.add('loading');
      const delay = ms => new Promise(res => setTimeout(res, ms));
      const tasksPromise = fetch(`${API}/view?status=${currentFilter}`).then(r => r.json());
      await Promise.all([tasksPromise, delay(3000)]); // Delay 3s
      const tasks = await tasksPromise;
      renderList(tasks);
      document.body.classList.remove('loading');
    }

    function renderList(tasks) {
      list.innerHTML = '';
      if (!tasks.length) {
        list.innerHTML = '<li class="empty">No tasks found</li>';
        return;
      }
      tasks.forEach(renderTask);
    }

    function renderTask(t) {
      const li = document.createElement('li');
      li.className = `task ${t.completed ? 'completed' : ''} ${t.deletedAt ? 'trashed' : ''}`;

      const content = document.createElement('div');
      content.className = 'task-content';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = t.completed;
      cb.disabled = !!t.deletedAt;
      cb.onclick = () => toggleComplete(t);
      const txt = document.createElement('span');
      txt.textContent = t.text;
      const dt = document.createElement('small');
      dt.textContent = `Created: ${new Date(t.createdAt).toLocaleString()}`;
      content.append(cb, txt, dt);

      if (t.attachment) {
        const fileLink = document.createElement('div');
        fileLink.className = 'attachment';
        fileLink.innerHTML = `<a href="/${t.attachment}" target="_blank">📎 View Attachment</a>`;
        content.appendChild(fileLink);
      }

      const actions = document.createElement('div');
      actions.className = 'actions';

      if (t.deletedAt) {
        actions.append(icon('♻ Restore', () => restoreTask(t)), icon('🗑 Delete', () => permanentDeleteTask(t), 'delete'));
      } else {
        actions.append(icon('✏', () => editTask(li, t)), icon('🗑', () => softDeleteTask(t), 'delete'));
      }

      li.append(content, actions);
      list.appendChild(li);
    }

    const icon = (txt, fn, cls = '') => {
      const b = document.createElement('button');
      b.className = `icon ${cls}`;
      b.textContent = txt;
      b.onclick = fn;
      return b;
    };

    form.onsubmit = async e => {
      e.preventDefault();
      const txt = input.value.trim();
      if (!txt) return;

      const formData = new FormData();
      formData.append('text', txt);
      if (fileInput.files[0]) formData.append('attachment', fileInput.files[0]);

      await fetch(`${API}/create`, { method: 'POST', body: formData });
      input.value = '';
      fileInput.value = '';
      loadTasks();
    };

    async function toggleComplete(t) {
      await fetch(`${API}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ primary: t._id, completed: !t.completed })
      });
      loadTasks();
    }

    function editTask(li, t) {
      if (li.classList.contains('editing')) return;
      li.classList.add('editing');
      const content = li.querySelector('.task-content');
      const old = content.querySelector('span').textContent;
      const inp = document.createElement('input');
      inp.className = 'editField';
      inp.value = old;

      const actions = li.querySelector('.actions');
      actions.innerHTML = '';
      actions.append(icon('💾', async () => {
        const nt = inp.value.trim();
        if (!nt) return alert('Task text required');
        await fetch(`${API}/${t._id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: nt })
        });
        loadTasks();
      }), icon('✖', loadTasks, 'cancel'));

      content.innerHTML = '';
      content.appendChild(inp);
      inp.focus();
    }

    async function softDeleteTask(t) {
      if (!confirm('Move to trash?')) return;
      await fetch(`${API}/delete/${t._id}`, { method: 'DELETE' });
      setTimeout(loadTasks, 300);
    }

    async function restoreTask(t) {
      await fetch(`${API}/restore/${t._id}`, { method: 'PATCH' });
      loadTasks();
    }

    async function permanentDeleteTask(t) {
      if (!confirm('Permanently delete this task?')) return;
      await fetch(`${API}/permanent-delete/${t._id}`, { method: 'DELETE' });
      loadTasks();
    }

    function updateActiveFilter() {
      document.querySelectorAll('.filters button').forEach(b => b.classList.remove('active'));
      if (currentFilter === 'completed') completedBtn.classList.add('active');
    }

    filter.onchange = e => {
      currentFilter = e.target.value;
      updateActiveFilter();
      loadTasks();
    };

    completedBtn.onclick = () => {
      currentFilter = 'completed';
      filter.value = 'completed';
      updateActiveFilter();
      loadTasks().then(() => list.scrollIntoView({ behavior: 'smooth' }));
    };

    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark');
      $('#themeToggle').checked = true;
    }

    $('#themeToggle').addEventListener('change', () => {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    loadTasks();
  </script>
</body>
</html>
