<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Todo Flow â€“ Modern CRUD with Files</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root {
      --primary: #007bff;
      --success: #28a745;
      --danger: #dc3545;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      box-sizing: border-box;
      transition: background 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    body {
      background: linear-gradient(to right top, #6a11cb, #2575fc);
      color: #222;
    }

    body.dark {
      background: #121212;
      color: #fff;
    }

    .container {
      max-width: 600px;
      margin: 2rem auto;
      padding: 1.2rem;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }

    body.dark .container {
      background: rgba(30, 30, 30, 0.9);
    }

    h1 {
      text-align: center;
      margin-bottom: 1.2rem;
    }

    form#taskForm {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    form#taskForm input[type="text"],
form#taskForm input[type="file"] {
  flex: 1 1 100%;
  padding: 0.65rem 1rem;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 8px;
  background-color: #fff;
  box-sizing: border-box;
  transition: border-color 0.3s, box-shadow 0.3s;
}

form#taskForm input[type="text"]:focus,
form#taskForm input[type="file"]:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}


    form#taskForm button[type="submit"]:hover {
      background: #218838;
    }

    @media (min-width: 768px) {
      form#taskForm input[type="text"] { min-width: 250px; }
      form#taskForm input[type="file"] { min-width: 180px; }
      form#taskForm button[type="submit"] { min-width: 100px; }
    }

    .filters {
      display: flex;
      gap: 10px;
      margin: 1rem 0;
      flex-wrap: wrap;
      align-items: center;
    }

    .filters select,
    .filters button {
      padding: 0.5rem 1rem;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      border-radius: 5px;
      transition: background 0.3s;
    }

    .filters button.active {
      background: #0056b3;
    }

    .task {
      background: rgba(255,255,255,0.9);
      padding: 0.8rem;
      margin-bottom: 0.6rem;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    body.dark .task {
      background: #2a2a2a;
    }

    .task-content {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .task.completed span {
      text-decoration: line-through;
      color: gray;
    }

    .attachment {
      margin-top: 4px;
    }

    .attachment a {
      font-size: 0.9em;
      color: var(--primary);
    }

    .actions {
      display: flex;
      gap: 0.5rem;
    }

    .actions button {
      padding: 4px 8px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.85rem;
      background: var(--primary);
      color: white;
    }

    .actions button.delete {
      background: var(--danger);
    }

    .editField {
      padding: 5px;
      font-size: 1rem;
      border-radius: 4px;
    }

    /* Loader */
    .pl {
      display: none;
      position: fixed;
      top: 400px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    body.loading .pl {
      display: block;
      opacity: 1;
    }
/* From Uiverse.io by SelfMadeSystem */ 
.absolute {
  position: absolute;
}

.inline-block {
  display: inline-block;
}

.loader {
  position: fixed;
  top: 75%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: none;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  z-index: 9999;
  padding: 1rem 2rem;
  border-radius: 16px;
  box-shadow: 0 0 25px rgba(0,0,0,0.2);
  backdrop-filter: blur(8px);
  transition: opacity 0.3s ease;
}

body.dark .loader {
  background: rgba(18, 18, 18, 0.85);
}

body.loading .loader {
  display: flex;
}


.w-2 {
  width: 0.5em;
}

.dash {
  animation: dashArray 2s ease-in-out infinite,
    dashOffset 2s linear infinite;
}

.spin {
  animation: spinDashArray 2s ease-in-out infinite,
    spin 8s ease-in-out infinite,
    dashOffset 2s linear infinite;
  transform-origin: center;
}

@keyframes dashArray {
  0% {
    stroke-dasharray: 0 1 359 0;
  }

  50% {
    stroke-dasharray: 0 359 1 0;
  }

  100% {
    stroke-dasharray: 359 1 0 0;
  }
}

@keyframes spinDashArray {
  0% {
    stroke-dasharray: 270 90;
  }

  50% {
    stroke-dasharray: 0 360;
  }

  100% {
    stroke-dasharray: 270 90;
  }
}

@keyframes dashOffset {
  0% {
    stroke-dashoffset: 365;
  }

  100% {
    stroke-dashoffset: 5;
  }
}

@keyframes spin {
  0% {
    rotate: 0deg;
  }

  12.5%,
  25% {
    rotate: 270deg;
  }

  37.5%,
  50% {
    rotate: 540deg;
  }

  62.5%,
  75% {
    rotate: 810deg;
  }

  87.5%,
  100% {
    rotate: 1080deg;
  }
}

    /* Dark mode switch */
    .ui-switch {
      --switch-width: 48px;
      --switch-height: 24px;
      --circle-size: 22px;
      position: relative;
      width: var(--switch-width);
      height: var(--switch-height);
      display: inline-block;
    }

    .ui-switch input {
      display: none;
    }

    .ui-switch .slider {
      background: #aaa;
      border-radius: var(--switch-height);
      height: var(--switch-height);
      position: relative;
      transition: background 0.3s;
    }

    .ui-switch .circle {
      background: white;
      border-radius: 50%;
      width: var(--circle-size);
      height: var(--circle-size);
      position: absolute;
      top: 1px;
      left: 1px;
      transition: transform 0.3s;
    }

    .ui-switch input:checked + .slider .circle {
      transform: translateX(calc(var(--switch-width) - var(--circle-size) - 2px));
    }

    /* Responsive */
    @media (max-width: 500px) {
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Todo Flow</h1>
    <form id="taskForm">
      <input id="taskInput" type="text" placeholder="New task" required />
      <input type="file" id="fileInput" name="attachment" />
      <button type="submit">Add</button>
    </form>

    <div class="filters">
      <select id="filter">
        <option value="all">All</option>
        <option value="completed">Completed</option>
        <option value="incomplete">Incomplete</option>
        <option value="trashed">Trash</option>
      </select>
      <button id="completedBtn">âœ” Completed</button>
      <label class="ui-switch" style="margin-left:auto;">
        <input type="checkbox" id="themeToggle" />
        <div class="slider"><div class="circle"></div></div>
      </label>
    </div>

    <ul id="taskList"></ul>
  </div>

  <!-- ðŸŒ€ Loader SVG -->
 <!-- From Uiverse.io by SelfMadeSystem --> 
<div class="loader">
  <svg height="0" width="0" viewBox="0 0 64 64" class="absolute">
    <defs class="s-xJBuHA073rTt" xmlns="http://www.w3.org/2000/svg">
      <linearGradient class="s-xJBuHA073rTt" gradientUnits="userSpaceOnUse" y2="2" x2="0" y1="62" x1="0" id="b">
        <stop class="s-xJBuHA073rTt" stop-color="#973BED"></stop>
        <stop class="s-xJBuHA073rTt" stop-color="#007CFF" offset="1"></stop>
      </linearGradient>
      <linearGradient class="s-xJBuHA073rTt" gradientUnits="userSpaceOnUse" y2="0" x2="0" y1="64" x1="0" id="c">
        <stop class="s-xJBuHA073rTt" stop-color="#FFC800"></stop>
        <stop class="s-xJBuHA073rTt" stop-color="#F0F" offset="1"></stop>
        <animateTransform repeatCount="indefinite" keySplines=".42,0,.58,1;.42,0,.58,1;.42,0,.58,1;.42,0,.58,1;.42,0,.58,1;.42,0,.58,1;.42,0,.58,1;.42,0,.58,1" keyTimes="0; 0.125; 0.25; 0.375; 0.5; 0.625; 0.75; 0.875; 1" dur="8s" values="0 32 32;-270 32 32;-270 32 32;-540 32 32;-540 32 32;-810 32 32;-810 32 32;-1080 32 32;-1080 32 32" type="rotate" attributeName="gradientTransform"></animateTransform>
      </linearGradient>
      <linearGradient class="s-xJBuHA073rTt" gradientUnits="userSpaceOnUse" y2="2" x2="0" y1="62" x1="0" id="d">
        <stop class="s-xJBuHA073rTt" stop-color="#00E0ED"></stop>
        <stop class="s-xJBuHA073rTt" stop-color="#00DA72" offset="1"></stop>
      </linearGradient>
    </defs>
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 64 64" height="64" width="64" class="inline-block">
    <path stroke-linejoin="round" stroke-linecap="round" stroke-width="8" stroke="url(#b)" d="M 54.722656,3.9726563 A 2.0002,2.0002 0 0 0 54.941406,4 h 5.007813 C 58.955121,17.046124 49.099667,27.677057 36.121094,29.580078 a 2.0002,2.0002 0 0 0 -1.708985,1.978516 V 60 H 29.587891 V 31.558594 A 2.0002,2.0002 0 0 0 27.878906,29.580078 C 14.900333,27.677057 5.0448787,17.046124 4.0507812,4 H 9.28125 c 1.231666,11.63657 10.984383,20.554048 22.6875,20.734375 a 2.0002,2.0002 0 0 0 0.02344,0 c 11.806958,0.04283 21.70649,-9.003371 22.730469,-20.7617187 z" class="dash" id="y" pathLength="360"></path>
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" style="--rotation-duration:0ms; --rotation-direction:normal;" viewBox="0 0 64 64" height="64" width="64" class="inline-block">
    <path stroke-linejoin="round" stroke-linecap="round" stroke-width="10" stroke="url(#c)" d="M 32 32
        m 0 -27
        a 27 27 0 1 1 0 54
        a 27 27 0 1 1 0 -54" class="spin" id="o" pathLength="360"></path>
  </svg>
  <div class="w-2"></div>
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" style="--rotation-duration:0ms; --rotation-direction:normal;" viewBox="0 0 64 64" height="64" width="64" class="inline-block">
    <path stroke-linejoin="round" stroke-linecap="round" stroke-width="8" stroke="url(#d)" d="M 4,4 h 4.6230469 v 25.919922 c -0.00276,11.916203 9.8364941,21.550422 21.7500001,21.296875 11.616666,-0.240651 21.014356,-9.63894 21.253906,-21.25586 a 2.0002,2.0002 0 0 0 0,-0.04102 V 4 H 56.25 v 25.919922 c 0,14.33873 -11.581192,25.919922 -25.919922,25.919922 a 2.0002,2.0002 0 0 0 -0.0293,0 C 15.812309,56.052941 3.998433,44.409961 4,29.919922 Z" class="dash" id="u" pathLength="360"></path>
  </svg>
</div>


  <script>
    const API = '/api/tasks';
    const $ = (s, c = document) => c.querySelector(s);
    const form = $('#taskForm'), input = $('#taskInput'), fileInput = $('#fileInput'), list = $('#taskList'),
          filter = $('#filter'), completedBtn = $('#completedBtn');
    let currentFilter = 'all';

    async function loadTasks() {
      document.body.classList.add('loading');
      const delay = ms => new Promise(res => setTimeout(res, ms));
      const tasksPromise = fetch(`${API}/view?status=${currentFilter}`).then(r => r.json());
      await Promise.all([tasksPromise, delay(3000)]); // Delay 3s
      const tasks = await tasksPromise;
      renderList(tasks);
      document.body.classList.remove('loading');
    }

    function renderList(tasks) {
      list.innerHTML = '';
      if (!tasks.length) {
        list.innerHTML = '<li class="empty">No tasks found</li>';
        return;
      }
      tasks.forEach(renderTask);
    }

    function renderTask(t) {
      const li = document.createElement('li');
      li.className = `task ${t.completed ? 'completed' : ''} ${t.deletedAt ? 'trashed' : ''}`;

      const content = document.createElement('div');
      content.className = 'task-content';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = t.completed;
      cb.disabled = !!t.deletedAt;
      cb.onclick = () => toggleComplete(t);
      const txt = document.createElement('span');
      txt.textContent = t.text;
      const dt = document.createElement('small');
      dt.textContent = `Created: ${new Date(t.createdAt).toLocaleString()}`;
      content.append(cb, txt, dt);

      if (t.attachment) {
        const fileLink = document.createElement('div');
        fileLink.className = 'attachment';
        fileLink.innerHTML = `<a href="/api/tasks/file/${t.attachment}" target="_blank">ðŸ“Ž View Attachment</a>`;

        content.appendChild(fileLink);
      }

      const actions = document.createElement('div');
      actions.className = 'actions';

      if (t.deletedAt) {
        actions.append(icon('â™» Restore', () => restoreTask(t)), icon('ðŸ—‘ Delete', () => permanentDeleteTask(t), 'delete'));
      } else {
        actions.append(icon('âœ', () => editTask(li, t)), icon('ðŸ—‘', () => softDeleteTask(t), 'delete'));
      }

      li.append(content, actions);
      list.appendChild(li);
    }

    const icon = (txt, fn, cls = '') => {
      const b = document.createElement('button');
      b.className = `icon ${cls}`;
      b.textContent = txt;
      b.onclick = fn;
      return b;
    };

    form.onsubmit = async e => {
      e.preventDefault();
      const txt = input.value.trim();
      if (!txt) return;

      const formData = new FormData();
      formData.append('text', txt);
      if (fileInput.files[0]) formData.append('attachment', fileInput.files[0]);

      await fetch(`${API}/create`, { method: 'POST', body: formData });
      input.value = '';
      fileInput.value = '';
      loadTasks();
    };

    async function toggleComplete(t) {
      await fetch(`${API}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ primary: t._id, completed: !t.completed })
      });
      loadTasks();
    }

    function editTask(li, t) {
      if (li.classList.contains('editing')) return;
      li.classList.add('editing');
      const content = li.querySelector('.task-content');
      const old = content.querySelector('span').textContent;
      const inp = document.createElement('input');
      inp.className = 'editField';
      inp.value = old;

      const actions = li.querySelector('.actions');
      actions.innerHTML = '';
      actions.append(icon('ðŸ’¾', async () => {
        const nt = inp.value.trim();
        if (!nt) return alert('Task text required');
        await fetch(`${API}/${t._id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: nt })
        });
        loadTasks();
      }), icon('âœ–', loadTasks, 'cancel'));

      content.innerHTML = '';
      content.appendChild(inp);
      inp.focus();
    }

    async function softDeleteTask(t) {
      if (!confirm('Move to trash?')) return;
      await fetch(`${API}/delete/${t._id}`, { method: 'DELETE' });
      setTimeout(loadTasks, 300);
    }

    async function restoreTask(t) {
      await fetch(`${API}/restore/${t._id}`, { method: 'PATCH' });
      loadTasks();
    }

    async function permanentDeleteTask(t) {
      if (!confirm('Permanently delete this task?')) return;
      await fetch(`${API}/permanent-delete/${t._id}`, { method: 'DELETE' });
      loadTasks();
    }

    function updateActiveFilter() {
      document.querySelectorAll('.filters button').forEach(b => b.classList.remove('active'));
      if (currentFilter === 'completed') completedBtn.classList.add('active');
    }

    filter.onchange = e => {
      currentFilter = e.target.value;
      updateActiveFilter();
      loadTasks();
    };

    completedBtn.onclick = () => {
      currentFilter = 'completed';
      filter.value = 'completed';
      updateActiveFilter();
      loadTasks().then(() => list.scrollIntoView({ behavior: 'smooth' }));
    };

    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark');
      $('#themeToggle').checked = true;
    }

    $('#themeToggle').addEventListener('change', () => {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    loadTasks();
  </script>
</body>
</html>
