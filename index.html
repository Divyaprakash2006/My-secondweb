<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Todo List – CRUD with Files</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body.dark { background: #1e1e1e; color: #fff; }
    body.dark .container { background: #2b2b2b; }
    body.loading .pl { display: block; }
    .pl {
      display: none;
      position: fixed;
      left: 50%;
      top: 400px;
      transform: translateX(-50%);
      z-index: 9999;
    }
    .filters {
      display: flex;
      gap: 10px;
      margin: 1rem 0;
      flex-wrap: wrap;
    }
    .filters button, .filters select {
      padding: 0.5rem 1rem;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 5px;
    }
    .filters button.active { background: #0056b3; }
    .task {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem;
      background: #f2f2f2;
      margin: 0.5rem 0;
      border-radius: 5px;
    }
    body.dark .task { background: #3a3a3a; }
    .task.completed span { text-decoration: line-through; color: gray; }
    .task-content { display: flex; flex-direction: column; }
    .actions button { margin-left: 5px; padding: 4px 8px; }
    .editField { padding: 5px; font-size: 1rem; }
    .attachment { margin-top: 5px; }
    .attachment a { color: #007bff; text-decoration: underline; font-size: 0.9em; }

    /* Responsive Form Styling */
    form#taskForm {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    form#taskForm input[type="text"],
    form#taskForm input[type="file"] {
      flex: 1 1 100%;
      padding: 0.4rem;
      font-size: 1rem;
    }
    form#taskForm button[type="submit"] {
      flex: 1 1 100%;
      padding: 0.5rem;
      font-size: 1rem;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    form#taskForm button[type="submit"]:hover {
      background: #218838;
    }

    @media (min-width: 768px) {
      form#taskForm input[type="text"] {
        flex: 1 1 auto;
        min-width: 250px;
      }
      form#taskForm input[type="file"] {
        flex: 1 1 auto;
        min-width: 180px;
      }
      form#taskForm button[type="submit"] {
        flex: 0 0 auto;
        min-width: 100px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Todo Flow</h1>
    <form id="taskForm">
      <input id="taskInput" type="text" placeholder="New task" required />
      <input type="file" id="fileInput" name="attachment" />
      <button type="submit">Add</button>
    </form>
    <div class="filters">
      <select id="filter">
        <option value="all">All</option>
        <option value="completed">Completed</option>
        <option value="incomplete">Incomplete</option>
        <option value="trashed">Trash</option>
      </select>
      <button id="completedBtn">✔️ Completed</button>
      <label class="ui-switch" style="margin-left: auto;">
        <input type="checkbox">
        <div class="slider"><div class="circle"></div></div>
      </label>
    </div>
    <ul id="taskList"></ul>
  </div>
 <svg class="pl" viewBox="0 0 160 160" width="160" height="160" xmlns="http://www.w3.org/2000/svg">
   <!-- From Uiverse.io by Nawsome --> 
			<defs>
				<linearGradient id="grad" x1="0" y1="0" x2="0" y2="1">
					<stop offset="0%" stop-color="#000"></stop>
					<stop offset="100%" stop-color="#fff"></stop>
				</linearGradient>
				<mask id="mask1">
					<rect x="0" y="0" width="160" height="160" fill="url(#grad)"></rect>
				</mask>
				<mask id="mask2">
					<rect x="28" y="28" width="104" height="104" fill="url(#grad)"></rect>
				</mask>
			</defs>
			
			<g>
				<g class="pl__ring-rotate">
					<circle class="pl__ring-stroke" cx="80" cy="80" r="72" fill="none" stroke="hsl(223,90%,55%)" stroke-width="16" stroke-dasharray="452.39 452.39" stroke-dashoffset="452" stroke-linecap="round" transform="rotate(-45,80,80)"></circle>
				</g>
			</g>
			<g mask="url(#mask1)">
				<g class="pl__ring-rotate">
					<circle class="pl__ring-stroke" cx="80" cy="80" r="72" fill="none" stroke="hsl(193,90%,55%)" stroke-width="16" stroke-dasharray="452.39 452.39" stroke-dashoffset="452" stroke-linecap="round" transform="rotate(-45,80,80)"></circle>
				</g>
			</g>
			
			<g>
				<g stroke-width="4" stroke-dasharray="12 12" stroke-dashoffset="12" stroke-linecap="round" transform="translate(80,80)">
					<polyline class="pl__tick" stroke="hsl(223,10%,90%)" points="0,2 0,14" transform="rotate(-135,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,10%,90%)" points="0,2 0,14" transform="rotate(-90,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,10%,90%)" points="0,2 0,14" transform="rotate(-45,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,10%,90%)" points="0,2 0,14" transform="rotate(0,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,10%,90%)" points="0,2 0,14" transform="rotate(45,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,10%,90%)" points="0,2 0,14" transform="rotate(90,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,10%,90%)" points="0,2 0,14" transform="rotate(135,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,10%,90%)" points="0,2 0,14" transform="rotate(180,0,0) translate(0,40)"></polyline>
				</g>
			</g>
			<g mask="url(#mask1)">
				<g stroke-width="4" stroke-dasharray="12 12" stroke-dashoffset="12" stroke-linecap="round" transform="translate(80,80)">
					<polyline class="pl__tick" stroke="hsl(223,90%,80%)" points="0,2 0,14" transform="rotate(-135,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,90%,80%)" points="0,2 0,14" transform="rotate(-90,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,90%,80%)" points="0,2 0,14" transform="rotate(-45,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,90%,80%)" points="0,2 0,14" transform="rotate(0,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,90%,80%)" points="0,2 0,14" transform="rotate(45,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,90%,80%)" points="0,2 0,14" transform="rotate(90,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,90%,80%)" points="0,2 0,14" transform="rotate(135,0,0) translate(0,40)"></polyline>
					<polyline class="pl__tick" stroke="hsl(223,90%,80%)" points="0,2 0,14" transform="rotate(180,0,0) translate(0,40)"></polyline>
				</g>
			</g>
			
			<g>
				<g transform="translate(64,28)">
					<g class="pl__arrows" transform="rotate(45,16,52)">
						<path fill="hsl(3,90%,55%)" d="M17.998,1.506l13.892,43.594c.455,1.426-.56,2.899-1.998,2.899H2.108c-1.437,0-2.452-1.473-1.998-2.899L14.002,1.506c.64-2.008,3.356-2.008,3.996,0Z"></path>
						<path fill="hsl(223,10%,90%)" d="M14.009,102.499L.109,58.889c-.453-1.421,.559-2.889,1.991-2.889H29.899c1.433,0,2.444,1.468,1.991,2.889l-13.899,43.61c-.638,2.001-3.345,2.001-3.983,0Z"></path>
					</g>
				</g>
			</g>
			<g mask="url(#mask2)">
				<g transform="translate(64,28)">
					<g class="pl__arrows" transform="rotate(45,16,52)">
						<path fill="hsl(333,90%,55%)" d="M17.998,1.506l13.892,43.594c.455,1.426-.56,2.899-1.998,2.899H2.108c-1.437,0-2.452-1.473-1.998-2.899L14.002,1.506c.64-2.008,3.356-2.008,3.996,0Z"></path>
						<path fill="hsl(223,90%,80%)" d="M14.009,102.499L.109,58.889c-.453-1.421,.559-2.889,1.991-2.889H29.899c1.433,0,2.444,1.468,1.991,2.889l-13.899,43.61c-.638,2.001-3.345,2.001-3.983,0Z"></path>
					</g>
				</g>
			</g>
		</svg>
  </svg>
  <!-- JavaScript remains unchanged -->
  <script>
    const API = '/api/tasks';
    const $ = (s, c = document) => c.querySelector(s);
    const form = $('#taskForm'), input = $('#taskInput'), fileInput = $('#fileInput'), list = $('#taskList'),
          filter = $('#filter'), completedBtn = $('#completedBtn');
    let currentFilter = 'all';

    async function loadTasks() {
      document.body.classList.add('loading');
      const delay = ms => new Promise(res => setTimeout(res, ms));
      const tasksPromise = fetch(`${API}/view?status=${currentFilter}`).then(r => r.json());
      await Promise.all([tasksPromise, delay(300)]);
      const tasks = await tasksPromise;
      renderList(tasks);
      document.body.classList.remove('loading');
    }

    function renderList(tasks) {
      list.innerHTML = '';
      if (!tasks.length) {
        list.innerHTML = '<li class="empty">No tasks found</li>';
        return;
      }
      tasks.forEach(renderTask);
    }

    function renderTask(t) {
      const li = document.createElement('li');
      li.className = `task ${t.completed ? 'completed' : ''} ${t.deletedAt ? 'trashed' : ''}`;

      const content = document.createElement('div');
      content.className = 'task-content';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = t.completed;
      cb.disabled = !!t.deletedAt;
      cb.onclick = () => toggleComplete(t);
      const txt = document.createElement('span');
      txt.textContent = t.text;
      const dt = document.createElement('small');
      dt.textContent = `Created: ${new Date(t.createdAt).toLocaleString()}`;
      content.append(cb, txt, dt);

      if (t.attachment) {
        const fileLink = document.createElement('div');
        fileLink.className = 'attachment';
        fileLink.innerHTML = `<a href="/${t.attachment}" target="_blank">📎 View Attachment</a>`;
        content.appendChild(fileLink);
      }

      const actions = document.createElement('div');
      actions.className = 'actions';

      if (t.deletedAt) {
        actions.append(
          icon('♻ Restore', () => restoreTask(t)),
          icon('🗑 Delete', () => permanentDeleteTask(t), 'delete')
        );
      } else {
        actions.append(
          icon('✏', () => editTask(li, t)),
          icon('🗑', () => softDeleteTask(t), 'delete')
        );
      }

      li.append(content, actions);
      list.appendChild(li);
    }

    const icon = (txt, fn, cls = '') => {
      const b = document.createElement('button');
      b.className = `icon ${cls}`;
      b.textContent = txt;
      b.onclick = fn;
      return b;
    };

    form.onsubmit = async e => {
      e.preventDefault();
      const txt = input.value.trim();
      if (!txt) return;

      const formData = new FormData();
      formData.append('text', txt);
      if (fileInput.files[0]) formData.append('attachment', fileInput.files[0]);

      await fetch(`${API}/create`, { method: 'POST', body: formData });
      input.value = '';
      fileInput.value = '';
      loadTasks();
    };

    async function toggleComplete(t) {
      await fetch(`${API}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ primary: t._id, completed: !t.completed })
      });
      loadTasks();
    }

    function editTask(li, t) {
      if (li.classList.contains('editing')) return;
      li.classList.add('editing');
      const content = li.querySelector('.task-content');
      const old = content.querySelector('span').textContent;
      const inp = document.createElement('input');
      inp.className = 'editField';
      inp.value = old;

      const actions = li.querySelector('.actions');
      actions.innerHTML = '';
      actions.append(
        icon('💾', async () => {
          const nt = inp.value.trim();
          if (!nt) return alert('Task text required');
          await fetch(`${API}/${t._id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: nt })
          });
          loadTasks();
        }),
        icon('✖', loadTasks, 'cancel')
      );

      content.innerHTML = '';
      content.appendChild(inp);
      inp.focus();
    }

    async function softDeleteTask(t) {
      if (!confirm('Move to trash?')) return;
      await fetch(`${API}/delete/${t._id}`, { method: 'DELETE' });
      setTimeout(loadTasks, 300);
    }

    async function restoreTask(t) {
      await fetch(`${API}/restore/${t._id}`, { method: 'PATCH' });
      loadTasks();
    }

    async function permanentDeleteTask(t) {
      if (!confirm('Permanently delete this task?')) return;
      await fetch(`${API}/permanent-delete/${t._id}`, { method: 'DELETE' });
      loadTasks();
    }

    filter.onchange = e => {
      currentFilter = e.target.value;
      loadTasks();
    };

    completedBtn.onclick = () => {
      currentFilter = 'completed';
      filter.value = 'completed';
      loadTasks().then(() => list.scrollIntoView({ behavior: 'smooth' }));
    };

    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark');
      $('.ui-switch input').checked = true;
    }

    $('.ui-switch input').addEventListener('change', () => {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    loadTasks();
  </script>
</body>
</html>
